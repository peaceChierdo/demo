<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">	
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <title>新闻瀑布流</title>
	<style type="text/css">
		* { margin: 0; padding: 0; }

	  #container {
	    display: flex;
	    justify-content: center;
	  }

	  #container > #col1,
	  #container > #col2,
	  #container > #col3 {
	    width: 250px;
	    min-height: 100px;
	    margin: 0 10px;
	    overflow: hidden;
	  }
	  
	  #container img {
	    max-width: 100%;
	    vertical-align: top;
	    margin-bottom: 10px;
	  }
	</style>
</head>


<body>
	<div id="container">
	  <div id="col1"></div>
	  <div id="col2"></div>
	  <div id="col3"></div>
	</div>

<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script>
		let $ct = $('.container') 
		let columns = [$('col1'), $('col2'), $('col3')]
		let ttHeights = [0,0,0]
		let currentPage = 1

		getOnePage(1, function () {
	    getOnePage(2, function () {
	      currentPage = 2
	    })
	  })

		function isBottom(){
			return $(window).height()+ $(window).scrollTop() >= $(document).height()
		}


	  $(window).scroll(function(){
	  	if(isBottom()){
	  		getOnePage(currentPage+1, function(){
	  			currentPage++
	  		})
	  	}
	  })


		function getOnePage(page,success){
			let number = 0
			let images = []
			getNews(8,page).then(function(response){ //这两处数字一致
				let data = response.data
				data.forEach( (item,index) => {
					let img = new Image()
					images.push(img)
					img.onload = function(){
						number++
						if(number==8){ //这两处数字一致 不然会出现 下面的图加载出来了 中间有个还没加载完的
							for (let i=0; i< images.length; i++){
								let minColIndex = findMinCol()
								$(`#col${minColIndex+1}`).append(images[i])
								ttHeights[minColIndex] += images[i].height + 10

							} 
						success && success()  // ?
						}
					}
					img.src = randomImage()
				})
			})
		}

		function randomImage(){
			let height = parseInt(Math.random()*150+150,10) // 200~300
			return `https://unsplash.it/250/${height}`
		}

		function findMinCol(){  // 第一排放完，数组全部刷新
			let minIndex = 0
			for(let i=0; i< ttHeights.length; i++){
				if(ttHeights[i] < ttHeights[minIndex]){
					minIndex = i
				}
			}
			return minIndex
		}





		function getNews (number, page) {
	    page = page || 1  // 保底
	    number = number || 8
	    let url = `http://platform.sina.com.cn/slide/album_tech` +
	      `?app_key=1271687855&num=${number}&page=${page}`
	    return $.ajax({
	      url: url,
	      dataType: 'jsonp',
	      jsonp: 'jsoncallback'
	    })
	  }




	</script>


</body>

</html>